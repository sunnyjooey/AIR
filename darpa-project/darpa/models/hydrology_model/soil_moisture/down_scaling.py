import datetime
import logging
import os

import pandas as pd
import rasterio
import rasterio.mask
from keras.callbacks import ModelCheckpoint
from luigi import Task
from luigi.configuration import get_config
from luigi.date_interval import Custom as CustomDateInterval
from luigi.parameter import DateIntervalParameter
from luigi.util import requires
from sklearn.model_selection import train_test_split

import pyspatialml
from kiluigi.parameter import GeoParameter
from kiluigi.targets import CkanTarget, IntermediateTarget
from models.hydrology_model.soil_moisture.data_cleaning import (
    ReprojectNDVI9km,
    ReprojectRetrivalNDVI2_25km,
    ScrapeSoilMoisture9km,
    WeightedResampleNDVIFrom9To2_25km,
    WeightedResampleNDVIFrom36To9km,
    WeightedResampleSoilMoistureFrom9To2_25km,
    WeightedResampleSoilMoistureFrom36To9km,
)
from models.hydrology_model.utils import mlp_model
from utils.scenario_tasks.functions.geography import MaskDataToGeography
from utils.scenario_tasks.functions.time import MaskDataToTime

logger = logging.getLogger("luigi-interface")

CONFIG = get_config()

CACHE_DIR = CONFIG.get("core", "cache_dir")

RELATIVE_PATH = "models/hydrology_model/soil_moisture/down_scaling"


@requires(
    ScrapeSoilMoisture9km,
    WeightedResampleSoilMoistureFrom36To9km,
    WeightedResampleNDVIFrom36To9km,
    ReprojectNDVI9km,
)
class ExtractDownscalingTrainingData(Task):

    """
    Prepare data for training the model
    """

    def output(self):
        return IntermediateTarget(
            path=f"{RELATIVE_PATH}/{self.task_id}", timeout=60 * 60 * 24 * 365
        )

    def map_f_path(self, path):
        filesname = [i for i in os.listdir(path) if i.endswith(".tif")]
        dir_map = {i.split(".")[0]: os.path.join(path, i) for i in filesname}
        return dir_map

    def run(self):
        sm_9km_map = self.map_f_path(self.input()[0].path)
        sm_45km_map = self.map_f_path(self.input()[1].path)
        ndvi_45km_map = self.map_f_path(self.input()[2].path)
        ndvi_9km_map = self.map_f_path(self.input()[3].path)

        df = pd.DataFrame()
        columnames = ["low_res_sm", "low_res_ndvi", "med_res_ndvi"]
        for _, key in enumerate(sm_45km_map):
            try:
                ndvi_key = self.get_ndvi_key(key)
                # Stack the variables
                features = [
                    sm_45km_map[key],
                    ndvi_45km_map[ndvi_key],
                    ndvi_9km_map[ndvi_key],
                ]
                stack = pyspatialml.stack_from_files(features)

                # Rename
                names = {old: new for old, new in zip(stack.names, columnames)}
                stack.rename(names)
                # Load a soil moisture data
                training_px = rasterio.open(sm_9km_map[key])

                # Extract data
                temp = stack.extract_raster(
                    response=training_px, value_name="med_res_sm"
                )

                if df.shape[0] == 0:
                    df = temp
                else:
                    df = pd.concat([df, temp])
                    df = df.reset_index(drop=True)
            except KeyError:
                logger.debug(f"The data for {key} is missing")

        with self.output().open("w") as out:
            out.write(df)

    def get_ndvi_key(self, sm_key):
        date_sm = datetime.datetime.strptime(sm_key, "%Y%m%d")
        ndvi_date = datetime.date(date_sm.year, date_sm.month, 1)
        ndvi_key = ndvi_date.strftime("%Y%m%d")
        return ndvi_key


@requires(ExtractDownscalingTrainingData)
class TrainDownscalingModel(Task):

    """
    Train neural network for downscaling the soil moisture
    """

    def output(self):
        return {
            "model": IntermediateTarget(
                path=f"{RELATIVE_PATH}/mlp_model", timeout=36000
            ),
            "weight": IntermediateTarget(
                path=f"{RELATIVE_PATH}/weights", timeout=36000
            ),
        }

    def run(self):
        with self.input().open("r") as f:
            df = f.read()

        X = df[["low_res_sm", "low_res_ndvi", "med_res_ndvi"]]
        y = df["med_res_sm"]
        # Split the training and testing data
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.25, random_state=42
        )

        # Multi-Layer Perceptrons
        model = mlp_model()

        # Save the model weight after every epoch
        checkpointer = ModelCheckpoint(
            filepath=self.output()["weight"].path, verbose=1, save_best_only=True
        )

        # Train the model
        model.fit(
            X_train,
            y_train,
            batch_size=128,
            epochs=20,
            verbose=0,
            validation_split=0.3,
            callbacks=[checkpointer],
        )

        # Save the model
        with self.output()["model"].open("w") as output:
            output.write(model)


@requires(WeightedResampleSoilMoistureFrom9To2_25km)
class MaskSoilMoistureFrom9To2_25kmToTime(MaskDataToTime):
    time = DateIntervalParameter(
        default=CustomDateInterval(
            datetime.date.fromisoformat("2015-05-01"),
            datetime.date.fromisoformat("2015-05-30"),
        )
    )


@requires(WeightedResampleNDVIFrom9To2_25km)
class MaskNDVIFrom9To2_25kmToTime(MaskDataToTime):
    time = DateIntervalParameter(
        default=CustomDateInterval(
            datetime.date.fromisoformat("2015-05-01"),
            datetime.date.fromisoformat("2015-05-30"),
        )
    )


@requires(ReprojectRetrivalNDVI2_25km)
class MaskNDVI2_25kmToTime(MaskDataToTime):
    time = DateIntervalParameter(
        default=CustomDateInterval(
            datetime.date.fromisoformat("2015-05-01"),
            datetime.date.fromisoformat("2015-05-30"),
        )
    )


@requires(MaskSoilMoistureFrom9To2_25kmToTime)
class MaskSoilMoistureFrom9To2_25kmToGeography(MaskDataToGeography):
    geography = GeoParameter(
        default={
            "coordinates": [
                [
                    [31.598_289_489_746_2, 3.689_588_069_915_83],
                    [31.590_587_615_966_9, 3.687_186_956_405_64],
                    [31.583_158_493_042, 3.684_878_110_885_73],
                    [31.577_369_689_941_5, 3.683_078_050_613_52],
                    [31.575_855_255_127, 3.682_615_041_732_84],
                    [31.560_937_881_469_8, 3.670_135_974_884_03],
                    [31.551_120_758_056_8, 3.661_477_088_928_22],
                    [31.545_703_887_939_5, 3.656_697_034_835_93],
                    [31.542_926_788_330_2, 3.656_543_016_433_83],
                    [31.539_665_222_168, 3.656_362_056_732_18],
                    [31.537_252_426_147_6, 3.654_997_110_366_82],
                    [31.533_042_907_714_9, 3.652_614_116_668_81],
                    [31.521_564_483_642_7, 3.646_120_071_411_19],
                    [31.517_789_840_698_4, 3.638_498_067_855_95],
                    [31.516_435_623_168_9, 3.639_347_076_416_13],
                    [31.514_411_926_269_6, 3.640_328_884_124_81],
                    [31.512_567_520_141_7, 3.641_031_980_514_64],
                    [31.511_125_564_575_2, 3.641_201_019_287_17],
                    [31.509_010_314_941_5, 3.641_197_919_845_58],
                    [31.506_599_426_269_6, 3.641_402_006_149_35],
                    [31.504_962_921_142_7, 3.641_896_009_445_19],
                    [31.503_688_812_255_9, 3.642_762_899_398_8],
                    [31.502_321_243_286_1, 3.644_062_995_910_64],
                    [31.501_798_629_760_7, 3.644_324_064_254_87],
                    [31.501_981_735_229_6, 3.646_929_025_650_08],
                    [31.502_199_172_973_7, 3.648_937_940_597_53],
                    [31.502_223_968_505_9, 3.651_134_967_804_07],
                    [31.502_498_626_709_1, 3.652_981_042_862_05],
                    [31.502_994_537_353_6, 3.654_936_075_210_68],
                    [31.503_601_074_218_8, 3.656_999_111_175_54],
                    [31.504_318_237_304_8, 3.659_677_028_656_01],
                    [31.505_258_560_180_7, 3.662_020_921_707_21],
                    [31.506_170_272_827_3, 3.664_283_990_860_04],
                    [31.507_108_688_354_6, 3.666_954_040_527_46],
                    [31.507_970_809_936_5, 3.669_960_975_647_03],
                    [31.508_102_416_992_3, 3.670_419_931_411_8],
                    [31.508_485_794_067_4, 3.674_318_075_180_11],
                    [31.507_926_940_918_1, 3.676_660_060_882_57],
                    [31.500_026_702_881, 3.678_880_929_947_01],
                    [31.491_405_487_060_7, 3.682_193_994_522_1],
                    [31.487_577_438_354_5, 3.683_943_033_218_33],
                    [31.478_267_669_677_9, 3.688_122_987_747_14],
                    [31.474_012_374_877_9, 3.690_278_053_283_69],
                    [31.468_301_773_071_4, 3.693_217_039_108_33],
                    [31.463_798_522_949_3, 3.695_523_977_279_66],
                    [31.455_131_530_761_7, 3.699_326_038_360_6],
                    [31.442_399_978_637_7, 3.706_005_096_435_55],
                    [31.433_307_647_705_1, 3.712_183_952_331_66],
                    [31.427_188_873_291, 3.715_656_042_099],
                    [31.426_919_937_133_9, 3.715_809_106_826_78],
                    [31.424_261_093_139_7, 3.717_314_958_572_5],
                    [31.415_143_966_674_9, 3.722_688_913_345_39],
                    [31.406_166_076_660_2, 3.726_408_004_760_86],
                    [31.403_722_763_061_6, 3.727_644_920_349_12],
                    [31.397_262_573_242_2, 3.730_914_115_905_87],
                    [31.394_224_166_870_1, 3.732_400_894_165_15],
                    [31.388_475_418_090_8, 3.735_210_895_538_44],
                    [31.379_262_924_194_4, 3.740_340_948_104_8],
                    [31.370_357_513_427_7, 3.744_204_044_342_04],
                    [31.361_391_067_504_9, 3.748_773_097_991_94],
                    [31.352_451_324_462_9, 3.753_169_059_753_47],
                    [31.347_743_988_037_2, 3.756_443_023_681_7],
                    [31.342_210_769_653_4, 3.760_520_935_058_65],
                    [31.336_536_407_470_8, 3.764_705_896_377_62],
                    [31.324_756_622_314_4, 3.772_768_974_304_2],
                    [31.323_917_388_916_1, 3.773_375_988_006_65],
                    [31.322_736_740_112_3, 3.774_230_003_356_99],
                    [31.312_145_233_154_4, 3.781_526_088_714_71],
                    [31.300_697_326_660_2, 3.789_308_071_136_59],
                    [31.290_119_171_142_6, 3.796_540_975_570_74],
                    [31.289_995_193_481_4, 3.796_595_096_588_25],
                    [31.289_096_832_275_4, 3.796_955_108_642_52],
                    [31.288_394_927_978_6, 3.797_007_083_892_76],
                    [31.283_500_671_386_7, 3.797_039_031_982_48],
                    [31.249_170_303_344_7, 3.992_149_114_608_77],
                    [31.233_999_252_319_4, 4.031_661_033_630_37],
                    [31.239_450_454_711_9, 4.070_731_163_024_85],
                    [31.238_510_131_835_9, 4.122_389_793_396_11],
                    [31.249_780_654_907_2, 4.148_869_991_302_55],
                    [31.259_920_120_239_3, 4.173_620_223_999_08],
                    [31.268_749_237_060_6, 4.221_323_966_979_98],
                    [31.276_990_890_502_9, 4.271_319_866_180_48],
                    [31.292_280_197_143_6, 4.296_678_066_253_78],
                    [31.300_710_678_100_7, 4.319_694_995_880_18],
                    [31.314_409_255_981_4, 4.338_260_173_797_66],
                    [31.322_940_826_416_1, 4.332_295_894_622_8],
                    [31.371_170_043_945_4, 4.319_200_038_910_03],
                    [31.590_429_306_030_3, 3.994_004_011_154_29],
                    [31.577_239_990_234_4, 3.981_431_961_059_63],
                    [31.610_319_137_573_4, 3.949_496_030_807_5],
                    [31.655_359_268_188_5, 3.916_145_086_288_57],
                    [31.692_190_170_288_1, 3.912_363_052_368_16],
                    [31.712_400_436_401_4, 3.893_383_979_797_42],
                    [31.730_749_130_249, 3.864_715_099_334_72],
                    [31.756_479_263_305_8, 3.840_645_074_844_36],
                    [31.771_259_307_861_3, 3.831_439_971_923_94],
                    [31.792_974_472_046, 3.824_079_990_387_02],
                    [31.794_958_114_624, 3.823_237_895_965_63],
                    [31.796_031_951_904_4, 3.822_551_965_713_62],
                    [31.795_795_440_673_9, 3.822_335_004_806_63],
                    [31.795_873_641_967_9, 3.821_611_881_256_05],
                    [31.796_510_696_411_2, 3.820_616_960_525_57],
                    [31.796_514_511_108_4, 3.819_966_077_804_68],
                    [31.796_472_549_438_5, 3.819_188_117_981_01],
                    [31.795_604_705_810_6, 3.818_192_005_157_47],
                    [31.795_339_584_350_5, 3.817_749_023_437_56],
                    [31.795_209_884_643_6, 3.817_277_908_325_31],
                    [31.795_068_740_844_7, 3.816_617_012_023_87],
                    [31.795_072_555_542, 3.815_820_932_388_42],
                    [31.795_076_370_239_3, 3.815_332_889_556_89],
                    [31.795_372_009_277_5, 3.814_537_048_339_96],
                    [31.795_715_332_031_4, 3.814_030_885_696_41],
                    [31.796_472_549_438_5, 3.813_426_017_761_29],
                    [31.797_155_380_249_1, 3.813_074_111_938_59],
                    [31.797_885_894_775_5, 3.812_885_046_005_36],
                    [31.798_662_185_669_1, 3.812_696_933_746_45],
                    [31.799_345_016_479_4, 3.812_434_911_727_96],
                    [31.799_953_460_693_4, 3.812_146_902_084_46],
                    [31.800_611_495_971_7, 3.811_695_098_876_95],
                    [31.800_907_135_009_8, 3.811_188_936_233_63],
                    [31.801_143_646_240_3, 3.810_230_970_382_8],
                    [31.801_414_489_746_2, 3.809_552_907_943_73],
                    [31.801_637_649_536_2, 3.808_974_027_633_78],
                    [31.802_005_767_822_3, 3.808_394_908_905_03],
                    [31.802_228_927_612_3, 3.807_617_902_755_79],
                    [31.802_356_719_970_6, 3.806_794_881_820_68],
                    [31.802_360_534_668, 3.806_160_926_818_9],
                    [31.802_320_480_346_7, 3.805_664_062_5],
                    [31.802_251_815_795_9, 3.805_039_882_659_91],
                    [31.802_083_969_116_2, 3.804_740_905_761_72],
                    [31.801_891_326_904_4, 3.804_378_986_358_7],
                    [31.801_530_838_012_8, 3.803_889_989_852_96],
                    [31.801_218_032_836_9, 3.803_427_934_646_61],
                    [31.800_882_339_477_6, 3.802_911_996_841_43],
                    [31.800_617_218_017_7, 3.802_405_118_942_32],
                    [31.800_500_869_751, 3.801_871_061_325_19],
                    [31.800_502_777_099_6, 3.801_337_957_382_32],
                    [31.800_432_205_200_2, 3.801_021_099_090_69],
                    [31.800_046_920_776_4, 3.800_677_061_081_05],
                    [31.799_224_853_515_6, 3.800_087_928_772_09],
                    [31.798_303_604_125_9, 3.799_597_978_591_92],
                    [31.796_863_555_908_2, 3.798_799_991_607_72],
                    [31.796_573_638_916_1, 3.798_582_077_026_37],
                    [31.796_043_395_996_2, 3.798_238_039_016_72],
                    [31.795_436_859_131, 3.797_919_988_632_32],
                    [31.794_397_354_126, 3.797_204_017_639_27],
                    [31.793_939_590_454_1, 3.796_842_098_236_2],
                    [31.793_260_574_340_9, 3.796_442_985_534_72],
                    [31.793_046_951_294, 3.795_953_989_029_04],
                    [31.792_564_392_089_8, 3.795_375_108_718_93],
                    [31.792_032_241_821_3, 3.794_812_917_709_46],
                    [31.791_368_484_497_1, 3.794_332_027_435_36],
                    [31.790_739_059_448_4, 3.793_869_972_229],
                    [31.789_989_471_435_6, 3.793_597_936_630_36],
                    [31.789_455_413_818_4, 3.793_442_964_553_95],
                    [31.789_045_333_862_3, 3.793_226_003_646_91],
                    [31.788_730_621_338, 3.792_835_950_851_5],
                    [31.788_391_113_281_2, 3.792_809_009_552],
                    [31.788_223_266_601_6, 3.792_536_973_953_36],
                    [31.787_765_502_929_6, 3.791_948_080_062_87],
                    [31.787_015_914_917, 3.791_558_027_267_51],
                    [31.786_338_806_152_4, 3.791_069_030_761_78],
                    [31.785_722_732_543_9, 3.790_714_979_171_81],
                    [31.785_165_786_743_2, 3.790_199_041_366_63],
                    [31.784_368_515_014_7, 3.789_609_909_057_62],
                    [31.784_269_332_885_9, 3.789_555_072_784_48],
                    [31.783_546_447_754, 3.789_119_958_877_62],
                    [31.782_745_361_328_2, 3.789_064_884_185_79],
                    [31.782_089_233_398_4, 3.788_892_030_715_94],
                    [31.781_560_897_827_3, 3.788_376_092_910_77],
                    [31.780_981_063_842_9, 3.787_552_118_301_5],
                    [31.780_572_891_235_4, 3.786_962_985_992_54],
                    [31.779_703_140_258_8, 3.786_156_892_776_55],
                    [31.778_917_312_622_1, 3.785_604_000_091_67],
                    [31.778_337_478_637_7, 3.785_259_008_407_54],
                    [31.777_418_136_596_6, 3.784_868_955_612_18],
                    [31.776_571_273_803_8, 3.784_297_943_115_29],
                    [31.775_869_369_506_9, 3.783_835_887_908_94],
                    [31.775_217_056_274_4, 3.783_220_052_719_17],
                    [31.774_372_100_830_1, 3.782_685_041_427_73],
                    [31.773_357_391_357_4, 3.781_896_114_349_42],
                    [31.772_554_397_583, 3.781_181_097_030_64],
                    [31.772_354_125_976_6, 3.781_008_958_816_53],
                    [31.771_825_790_405_4, 3.780_392_885_208_24],
                    [31.771_148_681_640_7, 3.779_712_915_420_53],
                    [31.770_643_234_253, 3.779_078_960_418_81],
                    [31.769_918_441_772_6, 3.778_608_083_725_09],
                    [31.769_289_016_723_8, 3.778_145_074_844_42],
                    [31.768_346_786_499_1, 3.777_529_001_235_96],
                    [31.767_694_473_266_7, 3.776_968_002_319_28],
                    [31.766_813_278_198_3, 3.776_225_090_026_91],
                    [31.766_475_677_490_4, 3.775_808_095_932_01],
                    [31.765_871_047_973_6, 3.775_391_101_837_27],
                    [31.765_340_805_053_8, 3.774_801_969_528_31],
                    [31.764_785_766_601_6, 3.774_384_975_433_41],
                    [31.763_864_517_212, 3.773_950_099_945_07],
                    [31.763_282_775_879, 3.773_767_948_150_64],
                    [31.762_992_858_886_7, 3.773_622_989_654_6],
                    [31.762_340_545_654_3, 3.773_179_054_260_37],
                    [31.761_590_957_641_7, 3.772_644_042_968_75],
                    [31.761_169_433_593_8, 3.772_281_885_147_15],
                    [31.760_528_564_453_1, 3.771_738_052_368_16],
                    [31.759_757_995_605_5, 3.770_741_939_544_79],
                    [31.758_438_110_351_6, 3.770_015_954_971_37],
                    [31.757_400_512_695_4, 3.769_056_081_771_96],
                    [31.756_942_749_023_5, 3.768_733_978_271_48],
                    [31.756_603_240_966_8, 3.768_493_890_762_27],
                    [31.755_708_694_458_1, 3.767_976_999_282_84],
                    [31.755_371_093_75, 3.767_416_000_366_33],
                    [31.755_128_860_473_7, 3.766_985_893_249_45],
                    [31.754_915_237_426_8, 3.766_609_907_150_32],
                    [31.754_238_128_662_2, 3.766_103_029_251_21],
                    [31.754_154_205_322_3, 3.766_047_954_559_38],
                    [31.753_585_815_429_8, 3.765_686_035_156_31],
                    [31.752_546_310_424_9, 3.764_950_990_676_99],
                    [31.751_459_121_704_2, 3.764_189_958_572_44],
                    [31.751_312_255_859_5, 3.764_081_001_281_8],
                    [31.750_080_108_642_7, 3.763_156_890_869_25],
                    [31.749_488_830_566_4, 3.762_541_055_679_32],
                    [31.742_954_254_150_5, 3.756_311_893_463_19],
                    [31.742_626_190_185_7, 3.756_000_041_961_78],
                    [31.737_543_106_079_2, 3.754_075_050_354_06],
                    [31.728_641_510_009_8, 3.753_746_032_714_79],
                    [31.725_784_301_757_8, 3.751_507_043_838_56],
                    [31.722_610_473_632_9, 3.748_308_897_018_49],
                    [31.714_683_532_715, 3.734_241_008_758_66],
                    [31.712_738_037_109_4, 3.731_596_946_716_25],
                    [31.707_387_924_194_4, 3.724_334_001_541_19],
                    [31.692_453_384_399_4, 3.719_202_041_626_03],
                    [31.671_798_706_054_6, 3.715_336_084_365_96],
                    [31.643_522_262_573_2, 3.705_388_069_152_95],
                    [31.640_523_910_522_5, 3.704_307_079_315_19],
                    [31.629_936_218_261_8, 3.700_484_037_399_29],
                    [31.625_560_760_498_1, 3.698_904_037_475_7],
                    [31.615_640_640_258_8, 3.695_322_036_743_22],
                    [31.608_896_255_493_1, 3.692_878_961_563_17],
                    [31.598_289_489_746_2, 3.689_588_069_915_83],
                ]
            ],
            "type": "Polygon",
        }
    )


@requires(MaskNDVIFrom9To2_25kmToTime)
class MaskNDVIFrom9To2_25kmToGeography(MaskDataToGeography):
    geography = GeoParameter(
        default={
            "coordinates": [
                [
                    [31.598_289_489_746_2, 3.689_588_069_915_83],
                    [31.590_587_615_966_9, 3.687_186_956_405_64],
                    [31.583_158_493_042, 3.684_878_110_885_73],
                    [31.577_369_689_941_5, 3.683_078_050_613_52],
                    [31.575_855_255_127, 3.682_615_041_732_84],
                    [31.560_937_881_469_8, 3.670_135_974_884_03],
                    [31.551_120_758_056_8, 3.661_477_088_928_22],
                    [31.545_703_887_939_5, 3.656_697_034_835_93],
                    [31.542_926_788_330_2, 3.656_543_016_433_83],
                    [31.539_665_222_168, 3.656_362_056_732_18],
                    [31.537_252_426_147_6, 3.654_997_110_366_82],
                    [31.533_042_907_714_9, 3.652_614_116_668_81],
                    [31.521_564_483_642_7, 3.646_120_071_411_19],
                    [31.517_789_840_698_4, 3.638_498_067_855_95],
                    [31.516_435_623_168_9, 3.639_347_076_416_13],
                    [31.514_411_926_269_6, 3.640_328_884_124_81],
                    [31.512_567_520_141_7, 3.641_031_980_514_64],
                    [31.511_125_564_575_2, 3.641_201_019_287_17],
                    [31.509_010_314_941_5, 3.641_197_919_845_58],
                    [31.506_599_426_269_6, 3.641_402_006_149_35],
                    [31.504_962_921_142_7, 3.641_896_009_445_19],
                    [31.503_688_812_255_9, 3.642_762_899_398_8],
                    [31.502_321_243_286_1, 3.644_062_995_910_64],
                    [31.501_798_629_760_7, 3.644_324_064_254_87],
                    [31.501_981_735_229_6, 3.646_929_025_650_08],
                    [31.502_199_172_973_7, 3.648_937_940_597_53],
                    [31.502_223_968_505_9, 3.651_134_967_804_07],
                    [31.502_498_626_709_1, 3.652_981_042_862_05],
                    [31.502_994_537_353_6, 3.654_936_075_210_68],
                    [31.503_601_074_218_8, 3.656_999_111_175_54],
                    [31.504_318_237_304_8, 3.659_677_028_656_01],
                    [31.505_258_560_180_7, 3.662_020_921_707_21],
                    [31.506_170_272_827_3, 3.664_283_990_860_04],
                    [31.507_108_688_354_6, 3.666_954_040_527_46],
                    [31.507_970_809_936_5, 3.669_960_975_647_03],
                    [31.508_102_416_992_3, 3.670_419_931_411_8],
                    [31.508_485_794_067_4, 3.674_318_075_180_11],
                    [31.507_926_940_918_1, 3.676_660_060_882_57],
                    [31.500_026_702_881, 3.678_880_929_947_01],
                    [31.491_405_487_060_7, 3.682_193_994_522_1],
                    [31.487_577_438_354_5, 3.683_943_033_218_33],
                    [31.478_267_669_677_9, 3.688_122_987_747_14],
                    [31.474_012_374_877_9, 3.690_278_053_283_69],
                    [31.468_301_773_071_4, 3.693_217_039_108_33],
                    [31.463_798_522_949_3, 3.695_523_977_279_66],
                    [31.455_131_530_761_7, 3.699_326_038_360_6],
                    [31.442_399_978_637_7, 3.706_005_096_435_55],
                    [31.433_307_647_705_1, 3.712_183_952_331_66],
                    [31.427_188_873_291, 3.715_656_042_099],
                    [31.426_919_937_133_9, 3.715_809_106_826_78],
                    [31.424_261_093_139_7, 3.717_314_958_572_5],
                    [31.415_143_966_674_9, 3.722_688_913_345_39],
                    [31.406_166_076_660_2, 3.726_408_004_760_86],
                    [31.403_722_763_061_6, 3.727_644_920_349_12],
                    [31.397_262_573_242_2, 3.730_914_115_905_87],
                    [31.394_224_166_870_1, 3.732_400_894_165_15],
                    [31.388_475_418_090_8, 3.735_210_895_538_44],
                    [31.379_262_924_194_4, 3.740_340_948_104_8],
                    [31.370_357_513_427_7, 3.744_204_044_342_04],
                    [31.361_391_067_504_9, 3.748_773_097_991_94],
                    [31.352_451_324_462_9, 3.753_169_059_753_47],
                    [31.347_743_988_037_2, 3.756_443_023_681_7],
                    [31.342_210_769_653_4, 3.760_520_935_058_65],
                    [31.336_536_407_470_8, 3.764_705_896_377_62],
                    [31.324_756_622_314_4, 3.772_768_974_304_2],
                    [31.323_917_388_916_1, 3.773_375_988_006_65],
                    [31.322_736_740_112_3, 3.774_230_003_356_99],
                    [31.312_145_233_154_4, 3.781_526_088_714_71],
                    [31.300_697_326_660_2, 3.789_308_071_136_59],
                    [31.290_119_171_142_6, 3.796_540_975_570_74],
                    [31.289_995_193_481_4, 3.796_595_096_588_25],
                    [31.289_096_832_275_4, 3.796_955_108_642_52],
                    [31.288_394_927_978_6, 3.797_007_083_892_76],
                    [31.283_500_671_386_7, 3.797_039_031_982_48],
                    [31.249_170_303_344_7, 3.992_149_114_608_77],
                    [31.233_999_252_319_4, 4.031_661_033_630_37],
                    [31.239_450_454_711_9, 4.070_731_163_024_85],
                    [31.238_510_131_835_9, 4.122_389_793_396_11],
                    [31.249_780_654_907_2, 4.148_869_991_302_55],
                    [31.259_920_120_239_3, 4.173_620_223_999_08],
                    [31.268_749_237_060_6, 4.221_323_966_979_98],
                    [31.276_990_890_502_9, 4.271_319_866_180_48],
                    [31.292_280_197_143_6, 4.296_678_066_253_78],
                    [31.300_710_678_100_7, 4.319_694_995_880_18],
                    [31.314_409_255_981_4, 4.338_260_173_797_66],
                    [31.322_940_826_416_1, 4.332_295_894_622_8],
                    [31.371_170_043_945_4, 4.319_200_038_910_03],
                    [31.590_429_306_030_3, 3.994_004_011_154_29],
                    [31.577_239_990_234_4, 3.981_431_961_059_63],
                    [31.610_319_137_573_4, 3.949_496_030_807_5],
                    [31.655_359_268_188_5, 3.916_145_086_288_57],
                    [31.692_190_170_288_1, 3.912_363_052_368_16],
                    [31.712_400_436_401_4, 3.893_383_979_797_42],
                    [31.730_749_130_249, 3.864_715_099_334_72],
                    [31.756_479_263_305_8, 3.840_645_074_844_36],
                    [31.771_259_307_861_3, 3.831_439_971_923_94],
                    [31.792_974_472_046, 3.824_079_990_387_02],
                    [31.794_958_114_624, 3.823_237_895_965_63],
                    [31.796_031_951_904_4, 3.822_551_965_713_62],
                    [31.795_795_440_673_9, 3.822_335_004_806_63],
                    [31.795_873_641_967_9, 3.821_611_881_256_05],
                    [31.796_510_696_411_2, 3.820_616_960_525_57],
                    [31.796_514_511_108_4, 3.819_966_077_804_68],
                    [31.796_472_549_438_5, 3.819_188_117_981_01],
                    [31.795_604_705_810_6, 3.818_192_005_157_47],
                    [31.795_339_584_350_5, 3.817_749_023_437_56],
                    [31.795_209_884_643_6, 3.817_277_908_325_31],
                    [31.795_068_740_844_7, 3.816_617_012_023_87],
                    [31.795_072_555_542, 3.815_820_932_388_42],
                    [31.795_076_370_239_3, 3.815_332_889_556_89],
                    [31.795_372_009_277_5, 3.814_537_048_339_96],
                    [31.795_715_332_031_4, 3.814_030_885_696_41],
                    [31.796_472_549_438_5, 3.813_426_017_761_29],
                    [31.797_155_380_249_1, 3.813_074_111_938_59],
                    [31.797_885_894_775_5, 3.812_885_046_005_36],
                    [31.798_662_185_669_1, 3.812_696_933_746_45],
                    [31.799_345_016_479_4, 3.812_434_911_727_96],
                    [31.799_953_460_693_4, 3.812_146_902_084_46],
                    [31.800_611_495_971_7, 3.811_695_098_876_95],
                    [31.800_907_135_009_8, 3.811_188_936_233_63],
                    [31.801_143_646_240_3, 3.810_230_970_382_8],
                    [31.801_414_489_746_2, 3.809_552_907_943_73],
                    [31.801_637_649_536_2, 3.808_974_027_633_78],
                    [31.802_005_767_822_3, 3.808_394_908_905_03],
                    [31.802_228_927_612_3, 3.807_617_902_755_79],
                    [31.802_356_719_970_6, 3.806_794_881_820_68],
                    [31.802_360_534_668, 3.806_160_926_818_9],
                    [31.802_320_480_346_7, 3.805_664_062_5],
                    [31.802_251_815_795_9, 3.805_039_882_659_91],
                    [31.802_083_969_116_2, 3.804_740_905_761_72],
                    [31.801_891_326_904_4, 3.804_378_986_358_7],
                    [31.801_530_838_012_8, 3.803_889_989_852_96],
                    [31.801_218_032_836_9, 3.803_427_934_646_61],
                    [31.800_882_339_477_6, 3.802_911_996_841_43],
                    [31.800_617_218_017_7, 3.802_405_118_942_32],
                    [31.800_500_869_751, 3.801_871_061_325_19],
                    [31.800_502_777_099_6, 3.801_337_957_382_32],
                    [31.800_432_205_200_2, 3.801_021_099_090_69],
                    [31.800_046_920_776_4, 3.800_677_061_081_05],
                    [31.799_224_853_515_6, 3.800_087_928_772_09],
                    [31.798_303_604_125_9, 3.799_597_978_591_92],
                    [31.796_863_555_908_2, 3.798_799_991_607_72],
                    [31.796_573_638_916_1, 3.798_582_077_026_37],
                    [31.796_043_395_996_2, 3.798_238_039_016_72],
                    [31.795_436_859_131, 3.797_919_988_632_32],
                    [31.794_397_354_126, 3.797_204_017_639_27],
                    [31.793_939_590_454_1, 3.796_842_098_236_2],
                    [31.793_260_574_340_9, 3.796_442_985_534_72],
                    [31.793_046_951_294, 3.795_953_989_029_04],
                    [31.792_564_392_089_8, 3.795_375_108_718_93],
                    [31.792_032_241_821_3, 3.794_812_917_709_46],
                    [31.791_368_484_497_1, 3.794_332_027_435_36],
                    [31.790_739_059_448_4, 3.793_869_972_229],
                    [31.789_989_471_435_6, 3.793_597_936_630_36],
                    [31.789_455_413_818_4, 3.793_442_964_553_95],
                    [31.789_045_333_862_3, 3.793_226_003_646_91],
                    [31.788_730_621_338, 3.792_835_950_851_5],
                    [31.788_391_113_281_2, 3.792_809_009_552],
                    [31.788_223_266_601_6, 3.792_536_973_953_36],
                    [31.787_765_502_929_6, 3.791_948_080_062_87],
                    [31.787_015_914_917, 3.791_558_027_267_51],
                    [31.786_338_806_152_4, 3.791_069_030_761_78],
                    [31.785_722_732_543_9, 3.790_714_979_171_81],
                    [31.785_165_786_743_2, 3.790_199_041_366_63],
                    [31.784_368_515_014_7, 3.789_609_909_057_62],
                    [31.784_269_332_885_9, 3.789_555_072_784_48],
                    [31.783_546_447_754, 3.789_119_958_877_62],
                    [31.782_745_361_328_2, 3.789_064_884_185_79],
                    [31.782_089_233_398_4, 3.788_892_030_715_94],
                    [31.781_560_897_827_3, 3.788_376_092_910_77],
                    [31.780_981_063_842_9, 3.787_552_118_301_5],
                    [31.780_572_891_235_4, 3.786_962_985_992_54],
                    [31.779_703_140_258_8, 3.786_156_892_776_55],
                    [31.778_917_312_622_1, 3.785_604_000_091_67],
                    [31.778_337_478_637_7, 3.785_259_008_407_54],
                    [31.777_418_136_596_6, 3.784_868_955_612_18],
                    [31.776_571_273_803_8, 3.784_297_943_115_29],
                    [31.775_869_369_506_9, 3.783_835_887_908_94],
                    [31.775_217_056_274_4, 3.783_220_052_719_17],
                    [31.774_372_100_830_1, 3.782_685_041_427_73],
                    [31.773_357_391_357_4, 3.781_896_114_349_42],
                    [31.772_554_397_583, 3.781_181_097_030_64],
                    [31.772_354_125_976_6, 3.781_008_958_816_53],
                    [31.771_825_790_405_4, 3.780_392_885_208_24],
                    [31.771_148_681_640_7, 3.779_712_915_420_53],
                    [31.770_643_234_253, 3.779_078_960_418_81],
                    [31.769_918_441_772_6, 3.778_608_083_725_09],
                    [31.769_289_016_723_8, 3.778_145_074_844_42],
                    [31.768_346_786_499_1, 3.777_529_001_235_96],
                    [31.767_694_473_266_7, 3.776_968_002_319_28],
                    [31.766_813_278_198_3, 3.776_225_090_026_91],
                    [31.766_475_677_490_4, 3.775_808_095_932_01],
                    [31.765_871_047_973_6, 3.775_391_101_837_27],
                    [31.765_340_805_053_8, 3.774_801_969_528_31],
                    [31.764_785_766_601_6, 3.774_384_975_433_41],
                    [31.763_864_517_212, 3.773_950_099_945_07],
                    [31.763_282_775_879, 3.773_767_948_150_64],
                    [31.762_992_858_886_7, 3.773_622_989_654_6],
                    [31.762_340_545_654_3, 3.773_179_054_260_37],
                    [31.761_590_957_641_7, 3.772_644_042_968_75],
                    [31.761_169_433_593_8, 3.772_281_885_147_15],
                    [31.760_528_564_453_1, 3.771_738_052_368_16],
                    [31.759_757_995_605_5, 3.770_741_939_544_79],
                    [31.758_438_110_351_6, 3.770_015_954_971_37],
                    [31.757_400_512_695_4, 3.769_056_081_771_96],
                    [31.756_942_749_023_5, 3.768_733_978_271_48],
                    [31.756_603_240_966_8, 3.768_493_890_762_27],
                    [31.755_708_694_458_1, 3.767_976_999_282_84],
                    [31.755_371_093_75, 3.767_416_000_366_33],
                    [31.755_128_860_473_7, 3.766_985_893_249_45],
                    [31.754_915_237_426_8, 3.766_609_907_150_32],
                    [31.754_238_128_662_2, 3.766_103_029_251_21],
                    [31.754_154_205_322_3, 3.766_047_954_559_38],
                    [31.753_585_815_429_8, 3.765_686_035_156_31],
                    [31.752_546_310_424_9, 3.764_950_990_676_99],
                    [31.751_459_121_704_2, 3.764_189_958_572_44],
                    [31.751_312_255_859_5, 3.764_081_001_281_8],
                    [31.750_080_108_642_7, 3.763_156_890_869_25],
                    [31.749_488_830_566_4, 3.762_541_055_679_32],
                    [31.742_954_254_150_5, 3.756_311_893_463_19],
                    [31.742_626_190_185_7, 3.756_000_041_961_78],
                    [31.737_543_106_079_2, 3.754_075_050_354_06],
                    [31.728_641_510_009_8, 3.753_746_032_714_79],
                    [31.725_784_301_757_8, 3.751_507_043_838_56],
                    [31.722_610_473_632_9, 3.748_308_897_018_49],
                    [31.714_683_532_715, 3.734_241_008_758_66],
                    [31.712_738_037_109_4, 3.731_596_946_716_25],
                    [31.707_387_924_194_4, 3.724_334_001_541_19],
                    [31.692_453_384_399_4, 3.719_202_041_626_03],
                    [31.671_798_706_054_6, 3.715_336_084_365_96],
                    [31.643_522_262_573_2, 3.705_388_069_152_95],
                    [31.640_523_910_522_5, 3.704_307_079_315_19],
                    [31.629_936_218_261_8, 3.700_484_037_399_29],
                    [31.625_560_760_498_1, 3.698_904_037_475_7],
                    [31.615_640_640_258_8, 3.695_322_036_743_22],
                    [31.608_896_255_493_1, 3.692_878_961_563_17],
                    [31.598_289_489_746_2, 3.689_588_069_915_83],
                ]
            ],
            "type": "Polygon",
        }
    )


@requires(MaskNDVI2_25kmToTime)
class MaskNDVI2_25kmToGeography(MaskDataToGeography):
    geography = GeoParameter(
        default={
            "coordinates": [
                [
                    [31.598_289_489_746_2, 3.689_588_069_915_83],
                    [31.590_587_615_966_9, 3.687_186_956_405_64],
                    [31.583_158_493_042, 3.684_878_110_885_73],
                    [31.577_369_689_941_5, 3.683_078_050_613_52],
                    [31.575_855_255_127, 3.682_615_041_732_84],
                    [31.560_937_881_469_8, 3.670_135_974_884_03],
                    [31.551_120_758_056_8, 3.661_477_088_928_22],
                    [31.545_703_887_939_5, 3.656_697_034_835_93],
                    [31.542_926_788_330_2, 3.656_543_016_433_83],
                    [31.539_665_222_168, 3.656_362_056_732_18],
                    [31.537_252_426_147_6, 3.654_997_110_366_82],
                    [31.533_042_907_714_9, 3.652_614_116_668_81],
                    [31.521_564_483_642_7, 3.646_120_071_411_19],
                    [31.517_789_840_698_4, 3.638_498_067_855_95],
                    [31.516_435_623_168_9, 3.639_347_076_416_13],
                    [31.514_411_926_269_6, 3.640_328_884_124_81],
                    [31.512_567_520_141_7, 3.641_031_980_514_64],
                    [31.511_125_564_575_2, 3.641_201_019_287_17],
                    [31.509_010_314_941_5, 3.641_197_919_845_58],
                    [31.506_599_426_269_6, 3.641_402_006_149_35],
                    [31.504_962_921_142_7, 3.641_896_009_445_19],
                    [31.503_688_812_255_9, 3.642_762_899_398_8],
                    [31.502_321_243_286_1, 3.644_062_995_910_64],
                    [31.501_798_629_760_7, 3.644_324_064_254_87],
                    [31.501_981_735_229_6, 3.646_929_025_650_08],
                    [31.502_199_172_973_7, 3.648_937_940_597_53],
                    [31.502_223_968_505_9, 3.651_134_967_804_07],
                    [31.502_498_626_709_1, 3.652_981_042_862_05],
                    [31.502_994_537_353_6, 3.654_936_075_210_68],
                    [31.503_601_074_218_8, 3.656_999_111_175_54],
                    [31.504_318_237_304_8, 3.659_677_028_656_01],
                    [31.505_258_560_180_7, 3.662_020_921_707_21],
                    [31.506_170_272_827_3, 3.664_283_990_860_04],
                    [31.507_108_688_354_6, 3.666_954_040_527_46],
                    [31.507_970_809_936_5, 3.669_960_975_647_03],
                    [31.508_102_416_992_3, 3.670_419_931_411_8],
                    [31.508_485_794_067_4, 3.674_318_075_180_11],
                    [31.507_926_940_918_1, 3.676_660_060_882_57],
                    [31.500_026_702_881, 3.678_880_929_947_01],
                    [31.491_405_487_060_7, 3.682_193_994_522_1],
                    [31.487_577_438_354_5, 3.683_943_033_218_33],
                    [31.478_267_669_677_9, 3.688_122_987_747_14],
                    [31.474_012_374_877_9, 3.690_278_053_283_69],
                    [31.468_301_773_071_4, 3.693_217_039_108_33],
                    [31.463_798_522_949_3, 3.695_523_977_279_66],
                    [31.455_131_530_761_7, 3.699_326_038_360_6],
                    [31.442_399_978_637_7, 3.706_005_096_435_55],
                    [31.433_307_647_705_1, 3.712_183_952_331_66],
                    [31.427_188_873_291, 3.715_656_042_099],
                    [31.426_919_937_133_9, 3.715_809_106_826_78],
                    [31.424_261_093_139_7, 3.717_314_958_572_5],
                    [31.415_143_966_674_9, 3.722_688_913_345_39],
                    [31.406_166_076_660_2, 3.726_408_004_760_86],
                    [31.403_722_763_061_6, 3.727_644_920_349_12],
                    [31.397_262_573_242_2, 3.730_914_115_905_87],
                    [31.394_224_166_870_1, 3.732_400_894_165_15],
                    [31.388_475_418_090_8, 3.735_210_895_538_44],
                    [31.379_262_924_194_4, 3.740_340_948_104_8],
                    [31.370_357_513_427_7, 3.744_204_044_342_04],
                    [31.361_391_067_504_9, 3.748_773_097_991_94],
                    [31.352_451_324_462_9, 3.753_169_059_753_47],
                    [31.347_743_988_037_2, 3.756_443_023_681_7],
                    [31.342_210_769_653_4, 3.760_520_935_058_65],
                    [31.336_536_407_470_8, 3.764_705_896_377_62],
                    [31.324_756_622_314_4, 3.772_768_974_304_2],
                    [31.323_917_388_916_1, 3.773_375_988_006_65],
                    [31.322_736_740_112_3, 3.774_230_003_356_99],
                    [31.312_145_233_154_4, 3.781_526_088_714_71],
                    [31.300_697_326_660_2, 3.789_308_071_136_59],
                    [31.290_119_171_142_6, 3.796_540_975_570_74],
                    [31.289_995_193_481_4, 3.796_595_096_588_25],
                    [31.289_096_832_275_4, 3.796_955_108_642_52],
                    [31.288_394_927_978_6, 3.797_007_083_892_76],
                    [31.283_500_671_386_7, 3.797_039_031_982_48],
                    [31.249_170_303_344_7, 3.992_149_114_608_77],
                    [31.233_999_252_319_4, 4.031_661_033_630_37],
                    [31.239_450_454_711_9, 4.070_731_163_024_85],
                    [31.238_510_131_835_9, 4.122_389_793_396_11],
                    [31.249_780_654_907_2, 4.148_869_991_302_55],
                    [31.259_920_120_239_3, 4.173_620_223_999_08],
                    [31.268_749_237_060_6, 4.221_323_966_979_98],
                    [31.276_990_890_502_9, 4.271_319_866_180_48],
                    [31.292_280_197_143_6, 4.296_678_066_253_78],
                    [31.300_710_678_100_7, 4.319_694_995_880_18],
                    [31.314_409_255_981_4, 4.338_260_173_797_66],
                    [31.322_940_826_416_1, 4.332_295_894_622_8],
                    [31.371_170_043_945_4, 4.319_200_038_910_03],
                    [31.590_429_306_030_3, 3.994_004_011_154_29],
                    [31.577_239_990_234_4, 3.981_431_961_059_63],
                    [31.610_319_137_573_4, 3.949_496_030_807_5],
                    [31.655_359_268_188_5, 3.916_145_086_288_57],
                    [31.692_190_170_288_1, 3.912_363_052_368_16],
                    [31.712_400_436_401_4, 3.893_383_979_797_42],
                    [31.730_749_130_249, 3.864_715_099_334_72],
                    [31.756_479_263_305_8, 3.840_645_074_844_36],
                    [31.771_259_307_861_3, 3.831_439_971_923_94],
                    [31.792_974_472_046, 3.824_079_990_387_02],
                    [31.794_958_114_624, 3.823_237_895_965_63],
                    [31.796_031_951_904_4, 3.822_551_965_713_62],
                    [31.795_795_440_673_9, 3.822_335_004_806_63],
                    [31.795_873_641_967_9, 3.821_611_881_256_05],
                    [31.796_510_696_411_2, 3.820_616_960_525_57],
                    [31.796_514_511_108_4, 3.819_966_077_804_68],
                    [31.796_472_549_438_5, 3.819_188_117_981_01],
                    [31.795_604_705_810_6, 3.818_192_005_157_47],
                    [31.795_339_584_350_5, 3.817_749_023_437_56],
                    [31.795_209_884_643_6, 3.817_277_908_325_31],
                    [31.795_068_740_844_7, 3.816_617_012_023_87],
                    [31.795_072_555_542, 3.815_820_932_388_42],
                    [31.795_076_370_239_3, 3.815_332_889_556_89],
                    [31.795_372_009_277_5, 3.814_537_048_339_96],
                    [31.795_715_332_031_4, 3.814_030_885_696_41],
                    [31.796_472_549_438_5, 3.813_426_017_761_29],
                    [31.797_155_380_249_1, 3.813_074_111_938_59],
                    [31.797_885_894_775_5, 3.812_885_046_005_36],
                    [31.798_662_185_669_1, 3.812_696_933_746_45],
                    [31.799_345_016_479_4, 3.812_434_911_727_96],
                    [31.799_953_460_693_4, 3.812_146_902_084_46],
                    [31.800_611_495_971_7, 3.811_695_098_876_95],
                    [31.800_907_135_009_8, 3.811_188_936_233_63],
                    [31.801_143_646_240_3, 3.810_230_970_382_8],
                    [31.801_414_489_746_2, 3.809_552_907_943_73],
                    [31.801_637_649_536_2, 3.808_974_027_633_78],
                    [31.802_005_767_822_3, 3.808_394_908_905_03],
                    [31.802_228_927_612_3, 3.807_617_902_755_79],
                    [31.802_356_719_970_6, 3.806_794_881_820_68],
                    [31.802_360_534_668, 3.806_160_926_818_9],
                    [31.802_320_480_346_7, 3.805_664_062_5],
                    [31.802_251_815_795_9, 3.805_039_882_659_91],
                    [31.802_083_969_116_2, 3.804_740_905_761_72],
                    [31.801_891_326_904_4, 3.804_378_986_358_7],
                    [31.801_530_838_012_8, 3.803_889_989_852_96],
                    [31.801_218_032_836_9, 3.803_427_934_646_61],
                    [31.800_882_339_477_6, 3.802_911_996_841_43],
                    [31.800_617_218_017_7, 3.802_405_118_942_32],
                    [31.800_500_869_751, 3.801_871_061_325_19],
                    [31.800_502_777_099_6, 3.801_337_957_382_32],
                    [31.800_432_205_200_2, 3.801_021_099_090_69],
                    [31.800_046_920_776_4, 3.800_677_061_081_05],
                    [31.799_224_853_515_6, 3.800_087_928_772_09],
                    [31.798_303_604_125_9, 3.799_597_978_591_92],
                    [31.796_863_555_908_2, 3.798_799_991_607_72],
                    [31.796_573_638_916_1, 3.798_582_077_026_37],
                    [31.796_043_395_996_2, 3.798_238_039_016_72],
                    [31.795_436_859_131, 3.797_919_988_632_32],
                    [31.794_397_354_126, 3.797_204_017_639_27],
                    [31.793_939_590_454_1, 3.796_842_098_236_2],
                    [31.793_260_574_340_9, 3.796_442_985_534_72],
                    [31.793_046_951_294, 3.795_953_989_029_04],
                    [31.792_564_392_089_8, 3.795_375_108_718_93],
                    [31.792_032_241_821_3, 3.794_812_917_709_46],
                    [31.791_368_484_497_1, 3.794_332_027_435_36],
                    [31.790_739_059_448_4, 3.793_869_972_229],
                    [31.789_989_471_435_6, 3.793_597_936_630_36],
                    [31.789_455_413_818_4, 3.793_442_964_553_95],
                    [31.789_045_333_862_3, 3.793_226_003_646_91],
                    [31.788_730_621_338, 3.792_835_950_851_5],
                    [31.788_391_113_281_2, 3.792_809_009_552],
                    [31.788_223_266_601_6, 3.792_536_973_953_36],
                    [31.787_765_502_929_6, 3.791_948_080_062_87],
                    [31.787_015_914_917, 3.791_558_027_267_51],
                    [31.786_338_806_152_4, 3.791_069_030_761_78],
                    [31.785_722_732_543_9, 3.790_714_979_171_81],
                    [31.785_165_786_743_2, 3.790_199_041_366_63],
                    [31.784_368_515_014_7, 3.789_609_909_057_62],
                    [31.784_269_332_885_9, 3.789_555_072_784_48],
                    [31.783_546_447_754, 3.789_119_958_877_62],
                    [31.782_745_361_328_2, 3.789_064_884_185_79],
                    [31.782_089_233_398_4, 3.788_892_030_715_94],
                    [31.781_560_897_827_3, 3.788_376_092_910_77],
                    [31.780_981_063_842_9, 3.787_552_118_301_5],
                    [31.780_572_891_235_4, 3.786_962_985_992_54],
                    [31.779_703_140_258_8, 3.786_156_892_776_55],
                    [31.778_917_312_622_1, 3.785_604_000_091_67],
                    [31.778_337_478_637_7, 3.785_259_008_407_54],
                    [31.777_418_136_596_6, 3.784_868_955_612_18],
                    [31.776_571_273_803_8, 3.784_297_943_115_29],
                    [31.775_869_369_506_9, 3.783_835_887_908_94],
                    [31.775_217_056_274_4, 3.783_220_052_719_17],
                    [31.774_372_100_830_1, 3.782_685_041_427_73],
                    [31.773_357_391_357_4, 3.781_896_114_349_42],
                    [31.772_554_397_583, 3.781_181_097_030_64],
                    [31.772_354_125_976_6, 3.781_008_958_816_53],
                    [31.771_825_790_405_4, 3.780_392_885_208_24],
                    [31.771_148_681_640_7, 3.779_712_915_420_53],
                    [31.770_643_234_253, 3.779_078_960_418_81],
                    [31.769_918_441_772_6, 3.778_608_083_725_09],
                    [31.769_289_016_723_8, 3.778_145_074_844_42],
                    [31.768_346_786_499_1, 3.777_529_001_235_96],
                    [31.767_694_473_266_7, 3.776_968_002_319_28],
                    [31.766_813_278_198_3, 3.776_225_090_026_91],
                    [31.766_475_677_490_4, 3.775_808_095_932_01],
                    [31.765_871_047_973_6, 3.775_391_101_837_27],
                    [31.765_340_805_053_8, 3.774_801_969_528_31],
                    [31.764_785_766_601_6, 3.774_384_975_433_41],
                    [31.763_864_517_212, 3.773_950_099_945_07],
                    [31.763_282_775_879, 3.773_767_948_150_64],
                    [31.762_992_858_886_7, 3.773_622_989_654_6],
                    [31.762_340_545_654_3, 3.773_179_054_260_37],
                    [31.761_590_957_641_7, 3.772_644_042_968_75],
                    [31.761_169_433_593_8, 3.772_281_885_147_15],
                    [31.760_528_564_453_1, 3.771_738_052_368_16],
                    [31.759_757_995_605_5, 3.770_741_939_544_79],
                    [31.758_438_110_351_6, 3.770_015_954_971_37],
                    [31.757_400_512_695_4, 3.769_056_081_771_96],
                    [31.756_942_749_023_5, 3.768_733_978_271_48],
                    [31.756_603_240_966_8, 3.768_493_890_762_27],
                    [31.755_708_694_458_1, 3.767_976_999_282_84],
                    [31.755_371_093_75, 3.767_416_000_366_33],
                    [31.755_128_860_473_7, 3.766_985_893_249_45],
                    [31.754_915_237_426_8, 3.766_609_907_150_32],
                    [31.754_238_128_662_2, 3.766_103_029_251_21],
                    [31.754_154_205_322_3, 3.766_047_954_559_38],
                    [31.753_585_815_429_8, 3.765_686_035_156_31],
                    [31.752_546_310_424_9, 3.764_950_990_676_99],
                    [31.751_459_121_704_2, 3.764_189_958_572_44],
                    [31.751_312_255_859_5, 3.764_081_001_281_8],
                    [31.750_080_108_642_7, 3.763_156_890_869_25],
                    [31.749_488_830_566_4, 3.762_541_055_679_32],
                    [31.742_954_254_150_5, 3.756_311_893_463_19],
                    [31.742_626_190_185_7, 3.756_000_041_961_78],
                    [31.737_543_106_079_2, 3.754_075_050_354_06],
                    [31.728_641_510_009_8, 3.753_746_032_714_79],
                    [31.725_784_301_757_8, 3.751_507_043_838_56],
                    [31.722_610_473_632_9, 3.748_308_897_018_49],
                    [31.714_683_532_715, 3.734_241_008_758_66],
                    [31.712_738_037_109_4, 3.731_596_946_716_25],
                    [31.707_387_924_194_4, 3.724_334_001_541_19],
                    [31.692_453_384_399_4, 3.719_202_041_626_03],
                    [31.671_798_706_054_6, 3.715_336_084_365_96],
                    [31.643_522_262_573_2, 3.705_388_069_152_95],
                    [31.640_523_910_522_5, 3.704_307_079_315_19],
                    [31.629_936_218_261_8, 3.700_484_037_399_29],
                    [31.625_560_760_498_1, 3.698_904_037_475_7],
                    [31.615_640_640_258_8, 3.695_322_036_743_22],
                    [31.608_896_255_493_1, 3.692_878_961_563_17],
                    [31.598_289_489_746_2, 3.689_588_069_915_83],
                ]
            ],
            "type": "Polygon",
        }
    )


@requires(
    TrainDownscalingModel,
    MaskSoilMoistureFrom9To2_25kmToGeography,
    MaskNDVIFrom9To2_25kmToGeography,
    MaskNDVI2_25kmToGeography,
)
class EstimateSoilMoisture(Task):

    """
    Downscale the soil moisture data
    """

    def output(self):
        return IntermediateTarget(
            path=f"{RELATIVE_PATH}/{self.task_id}/", timeout=60 * 60 * 24 * 365
        )

    def run(self):
        with self.input()[0]["model"].open("r") as f:
            model = f.read()

        sm_11_25km = self.input()[1]
        ndvi_11_25km = self.input()[2]
        ndvi_2_25km = self.input()[3]

        for d in [sm_11_25km, ndvi_11_25km, ndvi_2_25km]:
            d = {k: v.path for k, v in d.items()}

        with self.output().temporary_path as tmpdir:
            os.makedirs(tmpdir, exist_ok=True)

            for key in sm_11_25km:
                ndvi_key = self.get_ndvi_key(key)

                # Stack the variables
                variable_paths = [
                    sm_11_25km[key],
                    ndvi_11_25km[ndvi_key],
                    ndvi_2_25km[ndvi_key],
                ]

                stack = pyspatialml.stack_from_files(variable_paths)

                file_path = os.path.join(tmpdir, f"{key}.tif")

                stack.predict(estimator=model, file_path=file_path, nodata=-9999.0)

    def get_ndvi_key(self, sm_key):
        sm_key = datetime.datetime.strptime(sm_key, format="%Y%m%d")
        ndvi_key = sm_key.strftime("%Y%j")
        return ndvi_key


@requires(TrainDownscalingModel)
class UploadDownscalingModelToCkan(Task):

    """
    Task for uploading dowscaling model to ckan
    """

    def output(self):
        return CkanTarget(
            dataset={"id": "5a778a98-8ef4-4d69-97b8-d87682e00728"},
            resource={"name": "Dowscaling Soil Moisture Model"},
        )

    def run(self):
        file_path = self.input()["model"].path
        if self.output().exists():
            self.output().remove()
        self.output().put(file_path=file_path)
